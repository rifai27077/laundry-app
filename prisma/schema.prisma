generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Outlet {
  id     Int     @id @default(autoincrement())
  nama   String  @db.VarChar(100)
  alamat String  @db.Text
  tlp    String? @db.VarChar(15)

  users      User[]
  pakets     Paket[]
  transaksis Transaksi[]

  @@map("outlet")
}

model User {
  id        Int     @id @default(autoincrement())
  nama      String? @db.VarChar(100)
  username  String  @unique @db.VarChar(50)
  password  String  @db.VarChar(255)
  id_outlet Int?
  role      String  @db.VarChar(20) // 'admin', 'kasir', 'owner'

  outlet     Outlet?     @relation(fields: [id_outlet], references: [id], onDelete: SetNull)
  transaksis Transaksi[]

  @@map("users")
}

model Member {
  id            Int           @id @default(autoincrement())
  nama          String        @db.VarChar(100)
  alamat        String?       @db.Text
  jenis_kelamin JenisKelamin?
  tlp           String?       @db.VarChar(15)
  poin          Int           @default(0)
  saldo         Int           @default(0)

  transaksis Transaksi[]

  @@map("member")
}

model Paket {
  id         Int        @id @default(autoincrement())
  id_outlet  Int?
  jenis      JenisPaket
  nama_paket String?    @db.VarChar(100)
  harga      Int
  berat_kg   Int?       @default(0)

  outlet           Outlet?           @relation(fields: [id_outlet], references: [id])
  detailTransaksis DetailTransaksi[]

  @@index([id_outlet], map: "idx_paket_outlet")
  @@map("paket")
}

model Transaksi {
  id             Int           @id @default(autoincrement())
  id_outlet      Int?
  kode_invoice   String        @db.VarChar(100)
  id_member      Int?
  tgl            DateTime      @default(now()) @db.DateTime(6)
  batas_waktu    DateTime?     @db.DateTime(6)
  tgl_bayar      DateTime?     @db.DateTime(6)
  biaya_tambahan Int?          @default(0)
  diskon         Int?          @default(0)
  pajak          Int?          @default(0)
  status         StatusPesanan @default(baru)
  dibayar        StatusBayar   @default(belum_dibayar)
  id_user        Int?
  grand_total    Int?          @default(0)

  outlet           Outlet?           @relation(fields: [id_outlet], references: [id])
  member           Member?           @relation(fields: [id_member], references: [id])
  user             User?             @relation(fields: [id_user], references: [id])
  detailTransaksis DetailTransaksi[]
  pembayarans      Pembayaran[]

  @@index([id_outlet], map: "idx_transaksi_outlet")
  @@index([id_member], map: "idx_transaksi_member")
  @@index([id_user], map: "idx_transaksi_user")
  @@index([dibayar], map: "idx_transaksi_bayar")
  @@index([tgl], map: "idx_transaksi_tgl")
  @@index([status], map: "idx_transaksi_status")
  @@map("transaksi")
}

model DetailTransaksi {
  id           Int     @id @default(autoincrement())
  id_transaksi Int?    
  id_paket     Int?
  qty          Float   @db.Double
  keterangan   String? @db.Text
  harga        Int?

  transaksi Transaksi? @relation(fields: [id_transaksi], references: [id], onDelete: Cascade)
  paket     Paket?     @relation(fields: [id_paket], references: [id], onDelete: Restrict)

  @@unique([id_transaksi, id_paket], map: "unique_detail")
  @@index([id_transaksi], map: "idx_detail_transaksi_transaksi")
  @@index([id_paket], map: "idx_detail_transaksi_paket")
  @@map("detail_transaksi")
}

model Pembayaran {
  id                Int               @id @default(autoincrement())
  id_transaksi      Int?
  tgl_bayar         DateTime?         @default(now()) @db.DateTime(6)
  jumlah_bayar      Int
  metode_pembayaran MetodePembayaran?
  keterangan        String?           @db.Text

  transaksi Transaksi? @relation(fields: [id_transaksi], references: [id], onDelete: Cascade)

  @@index([id_transaksi], map: "idx_pembayaran_transaksi")
  @@map("pembayaran")
}

enum JenisKelamin {
  L
  P

  @@map("jenis_kelamin")
}

enum JenisPaket {
  kiloan
  selimut
  bed_cover
  kaos
  lain

  @@map("jenis_paket")
}

enum StatusBayar {
  dibayar
  belum_dibayar

  @@map("status_bayar")
}

enum StatusPesanan {
  baru
  proses
  selesai
  diambil
  dibatalkan

  @@map("status_pesanan")
}

enum MetodePembayaran {
  cash
  transfer
  qris
  saldo

  @@map("metode_pembayaran")
}

enum Role {
  admin
  kasir
  owner
}
